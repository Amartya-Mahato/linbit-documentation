<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter id="ch-admin">
  <title>Common administrative tasks</title>
  <para>
    <para>This chapter outlines typical administrative tasks
    encountered during day-to-day operations. It does not cover
      troubleshooting tasks, these are covered in detail in <xref
    linkend="ch-troubleshooting"/>.</para>
  </para>
  <section id="s-check-status">
    <title>Checking DRBD status</title>
    <section id="s-proc-drbd">
      <title>Status information in
      <filename>/proc/drbd</filename></title>
      <para><filename>/proc/drbd</filename> is a virtual file
	displaying real-time status information about all DRBD
	resources currently configured. You may interrogate this
	file's contents using this command:
	<literallayout><userinput>cat /proc/drbd</userinput>
	  <computeroutput>version: 8.2.4 (api:88/proto:86-88)
GIT-hash: fc00c6e00a1b6039bfcebe37afa3e7e28dbd92fa build by buildsystem@linbit, 2008-01-11 12:44:36
 0: cs:Connected st:Secondary/Secondary ds:UpToDate/UpToDate C r---
    ns:524288 nr:524288 dw:524288 dr:524288 al:0 bm:64 lo:0 pe:0 ua:0 ap:0
        resync: used:0/31 hits:524224 misses:64 starving:0 dirty:0 changed:64
        act_log: used:0/257 hits:0 misses:0 starving:0 dirty:0 changed:0</computeroutput></literallayout>
      </para>
      <para>The first line, prefixed with <code>version:</code>, shows
      the DRBD version used on your system. The second line contains
      information about this specific build.</para>
      <para>The other four lines in this example for a block that is
      repeated for every DRBD device configured, prefixed by the
	device minor number. In this case, this is <code>0</code>,
	corresponding to the device
      <filename>/dev/drbd0</filename>.</para>
      <para>The resource-specific output from
	<filename>/proc/drbd</filename> contains various pieces of
	information about the resource:
	<itemizedlist>
	  <listitem>
	    <formalpara>
	      <title>cs (connection state)</title>
	      <para>Status of the network connection. See <xref
	      linkend="s-connection-states"/> for details about the
	      various connection states.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>st (states)</title>
	      <para>Roles of the nodes. The role of the local node is
		displayed first, followed by the role of the partner
		node shown after the slash.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>ds (disk-states)</title>
	      <para>State of the hard disks. Prior to the slash the
		state of the local node is displayed, after the slash
		the state of the hard disk of the partner node is
		shown. See <xref
	      linkend="s-disk-states"/> for details about the various
		connection states.</para> 
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>ns (network send)</title>
	      <para> Volume of net data sent to the partner via the
		network connection; in Kibyte.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>nr (network receive)</title>
	      <para> Volume of net data received by the partner via
		the network connection; in Kibyte.</para> 
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>dw (disk write)</title>
	      <para>Net data written on local hard disk; in
		Kibyte.</para> 
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>dr (disk read)</title>
	      <para>Net data read from local hard disk; in Kibyte.
	      </para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>al (activity log)</title>
	      <para>Number of updates of the AL area of the meta
		data.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>bm (bit map)</title>
	      <para> Number of updates of the bitmap area of the meta
		data. </para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>lo (local count)</title>
	      <para>Number of open requests to the local I/O sub-system
		issued by DRBD. </para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>pe (pending)</title>
	      <para>Number of requests sent to the partner, but that
		have not yet been answered by the latter.</para> 
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>ua (unacked)</title>
	      <para>Number of requests received by the partner via the
		network connection, but that have not yet been
		answered. </para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>ap (application pending)</title>
	      <para>Number of block I/O requests forwarded to DRBD, but
		not yet answered by DRBD.</para> 
	    </formalpara>
	  </listitem>
	</itemizedlist>
      </para>
    </section>
    <section id="s-connection-states">
      <title>Connection states</title>
      <para>A resource's connection state can be observed either by
	monitoring <filename>/proc/drbd</filename>, or by issuing the
	<command>drbdadm cstate</command> command:
      <literallayout><userinput>drbdadm cstate <replaceable>resource</replaceable></userinput>
<computeroutput>Connected</computeroutput></literallayout></para>
      <para>A resource may have one of the following connection
	states:
	<itemizedlist>
	  <listitem>
	    <formalpara>
	      <title>StandAlone</title>
	      <para>No network configuration available. The resource
		has not yet been connected, or has been
		administratively disconnected (using <command>drbdadm
		  disconnect</command>), or has dropped its connection
		due to failed authentication or split brain.</para> 
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>Disconnecting</title>
	      <para> Temporary state during disconnection. The next
		state is StandAlone.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>Unconnected</title>
	      <para> Temporary state, prior to a connection attempt.
		Possible next states: WFConnection and
		WFReportParams.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>Timeout</title>
	      <para>Temporary state following a timeout in the
		communication with the peer. Next state:
		Unconnected.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>BrokenPipe</title>
	      <para>Temporary state after the connection to the peer
		was lost. Next state: Unconnected.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>NetworkFailure</title>
	      <para>Temporary state after the connection to the
		partner was lost. Next state: Unconnected.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>ProtocolError</title>
	      <para>Temporary state after the connection to the
		partner was lost. Next state: Unconnected.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>TearDown</title>
	      <para>Temporary state. The peer is closing the
		connection. Next state: Unconnected.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>WFConnection</title>
	      <para>This node is waiting until the peer node becomes
		visible on the network. </para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>WFReportParams</title>
	      <para>TCP connection has been established, this node
		waits for the first network packet from the
		peer.</para> 
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>Connected</title>
	      <para>A DRBD connection has been established, data
		mirroring is now active. This is the normal
		state.</para> 
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>StartingSyncS</title>
	      <para>Full resynchronization, initiated by the
		administrator, is just starting. The next possible
		states are: SyncSource or PausedSyncS.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>StartingSyncT</title>
	      <para>Full resynchronization, initiated by the
		administrator, is just starting. Next state:
		WFSyncUUID.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>WFBitMapS</title>
	      <para>Partial resnchronisation is just starting. Next
		possible states: SyncSource or PausedSyncS.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>WFBitMapT</title>
	      <para>Partial resnchronisation is just starting. Next
		possible state: WFSyncUUID.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>WFSyncUUID</title>
	      <para>Resynchronization is about to begin. Next possible
		states: SyncTarget or PausedSyncT.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>SyncSource</title>
	      <para>Resynchronization is currently running, with the
		local node being the source of
		resynchronization.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>SyncTarget</title>
	      <para>Resynchronization is currently running, with the
		local node being the target of
		resynchronization.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>PausedSyncS</title>
	      <para>The local node is the source of an ongoing
		resynchronization, but resynchronization is currently
		pased. This may be due to a dependency on the
		completion of another resynchronization process, or
		due to resynchronization having been manually
		interrupted by <command>drbdadm
		  pause-sync</command>.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>PausedSyncT</title>
	      <para>The local node is the target of an ongoing
		resynchronization, but resynchronization is currently
		pased. This may be due to a dependency on the
		completion of another resynchronization process, or
		due to resynchronization having been manually
		interrupted by <command>drbdadm
		  pause-sync</command>.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>VerifyS</title>
	      <para>On-line device verification is currently running,
		with the local node being the source of
		verification.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>VerifyT</title>
	      <para>On-line device verification is currently running,
		with the local node being the target of
		verification.</para>
	    </formalpara>
	  </listitem>
	</itemizedlist>
      </para>
    </section>
    <section id="s-disk-states">
      <title>Disk states</title>
      <para>A resource's connection state can be observed either by
	monitoring <filename>/proc/drbd</filename>, or by issuing the
	<command>drbdadm dstate</command> command:
      <literallayout><userinput>drbdadm dstate <replaceable>resource</replaceable></userinput>
<computeroutput>UpToDate/UpToDate</computeroutput></literallayout>
      The local disk state is always displayed first, the remote disk
      state last.</para>
      <para>
	Both the local and the remote disk state may be one of the
	following:
	<itemizedlist>
	  <listitem>
	    <formalpara>
	      <title>Diskless</title>
	      <para>No local block device has been assigned to the
		DRBD driver. This may mean that the resource has never
		attached to its backing device, that it has been
		manually detached using <command>drbdadm
		  detach</command>, or that it automatically detached
		after a lower-level I/O error.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>Attaching</title>
	      <para> Transient state during which meta data are
		read.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>Failed</title>
	      <para>Transient state following an I/O failure report by
		the local block device. Next state: Diskless.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>Negotiating</title>
	      <para>Transient state when an Attach is carried out on
		an already-connected DRBD device.</para> 
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>Inconsistent</title>
	      <para>The data are inconsistent, i.e. useless. This
		status occurs immediately upon creation of a new
		resource, on both nodes (before the initial full
		sync). Also, this status is found in one node (the
		synchronization target) during resynchronization.
	      </para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>Outdated</title>
	      <para>Resource data is consistent, but <link
		  linkend="s-outdate">outdated</link>.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>DUnknown</title>
	      <para>This state is used for the peer disk if no network
		connection is available.</para> 
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>Consistent</title>
	      <para>Consistent data of a node without connection. When
		the connection is established, it is decided whether
		the data are UpToDate or Outdated.</para>
	    </formalpara>
	  </listitem>
	  <listitem>
	    <formalpara>
	      <title>UpToDate</title>
	      <para>Consistent, up-to-date state of the data. This is
		the normal state.</para>
	    </formalpara>
	  </listitem>
	</itemizedlist>
      </para>
    </section>
  </section>
  <section id="s-enable-disable">
    <title>Enabling and disabling resources</title>
    <section id="s-enable-resource">
      <title>Enabling resources</title>
      <para>Normally, all resources configured in
	<filename>/etc/drbd.conf</filename> are automatically enabled
	upon system startup by the <filename>/etc/init.d/drbd</filename>
	init script. If you choose to disable this startup script (as
	may be required by some applications), you may enable specific
	resources by issuing the commands
      <literallayout><userinput>drbdadm attach <replaceable>resource</replaceable></userinput>
<userinput>drbdadm connect <replaceable>resource</replaceable></userinput></literallayout>
      or the shorthand version of the above,
      <literallayout><userinput>drbdadm up <replaceable>resource</replaceable></userinput></literallayout>
	</para>
      <para>As always, you may use the keyword <code>all</code>
	instead of a specific resource name if you want to enable all
	resources configured in <filename>/etc/drbd.conf</filename> at
	once.
      </para>
    </section>
    <section id="s-disable-resource">
      <title>Disabling resources</title>
      <para>You may temporarily disable specific
	resources by issuing the commands
      <literallayout><userinput>drbdadm disconnect <replaceable>resource</replaceable></userinput>
<userinput>drbdadm detach <replaceable>resource</replaceable></userinput></literallayout>
      or the shorthand version of the above,
      <literallayout><userinput>drbdadm down <replaceable>resource</replaceable></userinput></literallayout>
	<note>
	  <para>There is, in fact, a slight syntactical difference
	    between these two methods. While <command>drbdadm
	      down</command> implies a preceding <link
	      linkend="s-switch-resource-roles">resource
	      demotion</link>, <command>drbdadm
	      disconnect/detach</command> does not. So while you can
	    run <command>drbdadm down</command> on a resource that is
	    currently in the primary role, <command>drbdadm
	      disconnect/detach</command> in the same situation will
	    be refused by DRBD's internal state engine.</para>
	</note>
      </para>
      <para>Here, too, you may use the keyword <code>all</code> in
	place of a resource name if you wish to temporarily disable
	all resources listed in <filename>/etc/drbd.conf</filename> at
	once.
      </para>
    </section>
  </section>
  <section id="s-reconfigure">
    <title>Reconfiguring resources</title>
    <para>DRBD allows you to reconfigure resources while they are
      operational. To that end,
      <itemizedlist>
	<listitem>
	  <para>make any necessary changes to the resource
	    configuration in
	    <filename>/etc/drbd.conf</filename>,</para>
	</listitem>
	<listitem>
	  <para>synchronize your <filename>/etc/drbd.conf</filename>
	    file between both nodes,</para>
	</listitem>
	<listitem>
	  <para>issue the <command>drbdadm adjust
	      <replaceable>resource</replaceable></command> command on
	    both nodes.</para>
	</listitem>
      </itemizedlist>
    </para>
    <para><command>drbdadm adjust</command> then hands off to
      <command>drbdsetup</command> to make the necessary adjustments
      to the configuration. As always, you are able to review the
      pending <command>drbdsetup</command> invocations by running
      <command>drbdadm</command> with the <option>-d</option>
      (dry-run) option.</para>
    <note>
      <para>When making changes to the <code>common</code> section in
	<filename>/etc/drbd.conf</filename>, you can adjust the
	configuration for all resources in one run, by issuing
	<command>drbdadm adjust all</command>.</para>
    </note>
  </section>
  <section id="s-switch-resource-roles">
    <title>Promoting and demoting resources</title>
    <para>Manually switching a <link
	linkend="s-resource-roles">resource's role</link> from
      secondary to primary (promotion) or vice versa (demotion) is
      done using the following commands:
      <literallayout><userinput>drbdadm primary <replaceable>resource</replaceable></userinput>
<userinput>drbdadm secondary <replaceable>resource</replaceable></userinput></literallayout>
    </para>
      <para>
      In <link linkend="s-single-primary-mode">single-primary
	mode</link> (DRBD's default), any resource can be in the
      primary role on only one node at any given time while the <link
	linkend="s-connection-states">connection state</link> is
      <code>Connected</code>. Thus, issuing <command>drbdadm primary
	<replaceable>resource</replaceable></command> on one node
      while <replaceable>resource</replaceable> is still in the
      primary role on the peer will result in an error.</para>
    <para>A resource configured to allow <link
	linkend="s-dual-primary-mode">dual-primary mode</link> can be
	switched to the primary role on both nodes.</para>
  </section>
  <section id="s-enable-dual-primary">
    <title>Enabling dual-primary mode</title>
    <para>To enable dual-primary mode, add
	the <option>allow-two-primaries</option> option to the
	<code>net</code> section of your resource
	configuration:
	<programlisting>resource <replaceable>resource</replaceable>
  net { 
    allow-two-primaries; 
  }
  ...
}</programlisting></para>
    <para>
      When a resource is configured to support dual-primary mode, it
      may also be desirable to automatically switch the resource into
      the primary role upon system (or DRBD) startup. To do this, add
      the <option>become-primary-on</option> option to the
      <code>startup</code> section of your resource configuration:
      <programlisting>resource <replaceable>resource</replaceable>
  startup { 
    become-primary-on both;
  }
  ...
}</programlisting></para>
    <para>After you have made these changes to
      <filename>/etc/drbd.conf</filename>, do not forget to
      synchronize the configuration between nodes. Then, you can use
      <command>drbdadm adjust
      <replaceable>resource</replaceable></command> (on both nodes),
      and afterwards, <command>drbdadm primary
      <replaceable>resource</replaceable></command> (again, on both
      nodes).</para>
  </section>
  <section id="s-use-online-verify">
    <title>Using on-line device verification</title>
    <section id="s-online-verify-enable">
      <title>Enabling on-line verification</title>
      <para><link linkend="s-online-verify">On-line device
	  verification</link> is not enabled for resources by default.
	To enable it, add the following lines to your resource
	configuration in <filename>/etc/drbd.conf</filename>:
	<programlisting>resource <replaceable>resource</replaceable>
  net { 
    verify-alg <replaceable>algorithm</replaceable>;
  }
  ...
}</programlisting> 
	<replaceable>algorithm</replaceable>
	may be any message digest algorithm supported by the kernel
	crypto API in your system's kernel configuration. Normally,
	you should be able to choose at least from <code>sha1</code>,
	<code>md5</code>, and <code>crc32c</code>.</para>
      <para>If you make this change to an existing resource, as
	always, synchronize your <filename>drbd.conf</filename> to the
	peer. and run <command>drbdadm adjust
	  <replaceable>resource</replaceable></command> on both
	nodes.</para>
    </section>
    <section id="s-online-verify-invoke">
      <title>Invoking on-line verification</title>
      <para>After you have enabled on-line verification, you will be
	able to initiate a verification run using the following
	command: 
	<literallayout><userinput>drbdadm verify <replaceable>resource</replaceable></userinput></literallayout> 
	When you do so, DRBD starts an online verification run for
	<replaceable>resource</replaceable>, and if it detects any
	blocks not in sync, will mark those blocks as such and write a
	message to the kernel log. Any applications using the device
	at that time can continue to do so unimpeded, and you may also
	<link linkend="s-switch-resource-roles">switch resource
	  roles</link> at will.</para>
      <para>If out-of-sync blocks were detected during the
	verification run, you may resynchronize them using the
	following commands after verification has completed:
	<literallayout><userinput>drbdadm disconnect <replaceable>resource</replaceable></userinput>
<userinput>drbdadm connect <replaceable>resource</replaceable></userinput></literallayout>
      </para>
    </section>
    <section id="s-online-verify-automate">
      <title>Automating on-line verification</title>
      <para>Most users will want to automate on-line device
	verification. This can be easily accomplished. Create a file
	with the following contents, named
	<filename>/etc/cron.d/drbd-verify</filename> on
	<emphasis>one</emphasis> of your nodes:
      <programlisting>42 0 * * 0    root    /sbin/drbdadm verify <replaceable>resource</replaceable></programlisting>
	This will have <code>cron</code> invoke a device verification
      every Sunday at 42 minutes past midnight.</para>
      <para>If you have enabled on-line verification for all your
	resources (for example, by adding <code>verify-alg
	  <replaceable>algorithm</replaceable></code> to the
	  <code>common</code> section in
	<filename>/etc/drbd.conf</filename>), you may also use:
      <programlisting>42 0 * * 0    root    /sbin/drbdadm verify all</programlisting>
      </para>
    </section>
  </section>
  <section id="s-configure-syncer-rate">
    <title>Configuring the rate of re-synchronization</title>
    <para>Normally, one tries to ensure that background
      re-synchronization (which makes the data on the synchronization
      target temporarily inconsistent) completes as quickly as
      possible. However, it is also necessary to keep background
      re-synchronization from hogging all bandwidth otherwise
      available for foreground replication, which would be detrimental
      to application performance. Thus, you must configure the
      re-sychronization bandwidth to match your hardware &mdash; which
      you may do in a permanent fashion or on-the-fly.</para>
    <section id="s-configure-syncer-rate-permanent">
      <title>Permanent syncer rate configuration</title>
      <para>The maximum bandwidth a resource uses for background
	re-synchronization is permanently configured using the
	<option>rate</option> option for a resource. This must be
	included in the resource configuration's
	<option>syncer</option> section in
	<filename>/etc/drbd.conf</filename>:
	<programlisting>resource <replaceable>resource</replaceable>
  syncer { 
    rate 40M;
    ...
  }
  ...
}</programlisting></para>
      <para>Note that the rate setting is given in
	<emphasis>bytes</emphasis>, not <emphasis>bits</emphasis> per
	second. </para>
      <tip>
	<para>A good rule of thumb for this value is to use about 30%
	  of the available replication bandwidth. Thus, if you had an
	  I/O subsystem capable of sustaining write throughput of
	  180MB/s, and a Gigabit Ethernet network capable of
	  sustaining 110 MB/s network throughput (the network being
	  the bottleneck), you would calculate:
	  <equation id="eq-syncer-rate-example1">
	    <title>Syncer rate example, 110MB/s effective available
	      bandwidth</title>
	    <alt>\[110\cdot0.3=33\]</alt>
	    <graphic fileref="syncer-rate-example1"/>
	  </equation> Thus, the recommended value for the
	  <option>rate</option> option would be
	  <code>33M</code>.</para>
	<para>By contrast, if you had an I/O subsystem with a maximum
	  throughput of 80MB/s and a Gigabit Ethernet connection (the
	  I/O subsystem being the bottleneck), you would calculate:
	  <equation id="eq-syncer-rate-example2">
	    <title>Syncer rate example, 80MB/s effective available
	      bandwidth</title>
	    <alt>\[80\cdot0.3=24\]</alt>
	    <graphic fileref="syncer-rate-example2"/>
	  </equation> In this case, the recommended value for the
	  <option>rate</option> option would be
	  <code>24M</code>.
	</para>
      </tip>
    </section>
    <section id="s-configure-syncer-rate-temporary">
      <title>Temporary syncer rate configuration</title>
      <para>It is sometimes desirable to temporarily adjust the syncer
	rate. For example, you might want to speed up background
	re-synchronization after having performed scheduled
	maintenance on one of your cluster nodes. Or, you might want
	to throttle background re-synchronization if it happens to
	occur at a time when your application is extremely busy with
	write operations, and you want to make sure that a large
	portion of the existing bandwidth is available to
	replication.</para>
      <para>For example, in order to make most bandwidth of a Gigabit
	Ethernet link available to re-synchronization, issue the
	following command:
	<literallayout><userinput>drbdsetup <filename>/dev/drbd<replaceable>num</replaceable></filename> syncer -r 110M</userinput></literallayout> 
	As always, replace <replaceable>num</replaceable> with the
	device minor number of your DRBD device. You need to issue
	this command on only one of your nodes.</para>
      <para>To revert this temporary setting and re-enable the syncer
	rate set in <filename>/etc/drbd.conf</filename>, issue this
	command:
	<literallayout><userinput>drbdadm adjust <replaceable>resource</replaceable></userinput></literallayout>
      </para>
    </section>
  </section>
  <section id="s-configure-io-error-behavior">
    <title>Configuring I/O error handling strategies</title>
    <para>DRBD's <link linkend="s-handling-disk-errors">strategy for
	handling lower-level I/O errors</link> is determined by the
      <option>on-io-error</option> option, included in the resource
      <code>disk</code> configuration in
      <filename>/etc/drbd.conf</filename>:
      <programlisting>resource <replaceable>resource</replaceable> {
  disk {
    on-io-error <replaceable>strategy</replaceable>
    ...
  }
  ...
}</programlisting>
      You may, of course, set this in the <code>common</code> section
    too, if you want to define a global I/O error handling policy for
    all resources.</para>
    <para><replaceable>strategy</replaceable> may be one of the
    following options:
      <itemizedlist>
	<listitem>
	  <formalpara>
	    <title><option>detach</option></title>
	    <para>This is the recommended option, and also the
	      default. On the occurrence of a lower-level I/O error,
	      the node drops its backing device, and continues in
	      diskless mode.</para>
	  </formalpara>
	</listitem>
	<listitem>
	  <formalpara>
	    <title><option>pass_on</option></title>
	    <para>Causes DRBD to report the I/O error to the upper
	      layers. On the primary node, it is reported it to the
	      mounted file system. On the secondary node, it is
	      ignored (because the secondary has no upper layer to
	      report to).</para>
	  </formalpara>
	</listitem>
	<listitem>
	  <formalpara>
	    <title><option>call-local-io-error</option></title>
	    <para>Invokes the command defined as the local I/O error
	      handler. This requires that a corresponding
	      <option>local-io-error</option> command invocation is
	      defined in the resource's <code>handlers</code> section.
	      It is entirely left to the administrator's discretion to
	      implement I/O error handling using the command (or
	      script) invoked by <option>local-io-error</option>.
	      <note>
		<para>Early DRBD versions (prior to 8.0) included
		  another option, <option>panic</option>, which would
		  forcibly remove the node from the cluster by way of
		  a kernel panic, whenever a local I/O error occurred.
		  While that option is no longer available, the same
		  behavior may be mimicked via the
		  <option>local-io-error</option>/
		  <option>call-local-io-error</option> interface. You
		  should do so only if you fully understand the
		  implications of such behavior.</para>
	      </note>
	    </para>
	  </formalpara>
	</listitem>
      </itemizedlist>
    </para>
    <para>You may reconfigure a running resource's I/O error handling
      strategy by following the following process: 
      <itemizedlist>
	<listitem>
	  <para>Edit the resource configuration in
	    <filename>/etc/drbd.conf</filename>.</para>
	</listitem>
	<listitem>
	  <para>Copy the configuration to the peer node.</para>
	</listitem>
	<listitem>
	  <para>Issue
	    <command>drbdadm adjust <replaceable>resource</replaceable></command> 
	    on the node where the resource is currently in the
	    secondary role.</para>
	</listitem>
	<listitem>
	  <para>Switch resource roles (if your system is managed by a
	    cluster management application, this would involve a
	    manual switch-over of cluster resources).</para>
	</listitem>
	<listitem>
	  <para>Again, issue
	    <command>drbdadm adjust <replaceable>resource</replaceable></command> 
	    on the node where the resource is currently in the
	    secondary role (this is <emphasis>not</emphasis> the same
	    node as the one where you issued the command
	    earlier).</para>
	</listitem>
	<listitem>
	  <para>Switch resource roles (or cluster node roles) back, if
	    desired.</para>
	</listitem>
      </itemizedlist>
    </para>
  </section>
  <section id="s-resizing">
      <title>Resizing resources</title>
      <section id="s-growing-online">
	<title>Growing on-line</title>
	<para>If the backing block devices can be grown while in
	  operation (online), it is also possible to increase the size
	  of a DRBD device based on these devices during operation, on
	  condition that a Logical Volume Manager is used under
	  DRBD.</para>
	<para>Having grown the backing block devices on both nodes,
	  ensure that only one node is in primary state. Then enter on
	  one node:</para>
	<programlisting>drbdadm resize <replaceable>resource</replaceable></programlisting>
	<para>This triggers a resynchronization of the new section.
	  The synchronization is done from the primary node to the
	  secondary node.</para>
      </section>
      <section id="s-growing-offline">
	<title>Growing off-line</title>
	<para>When the backing block devices on both nodes are grown
	  while DRBD is inactive, the new size is recognized
	  automatically. No administrative intervention is
	  necessary.</para>
	<para>The resulting DRBD device will have the new size after
	  the next activation of DRBD on both nodes and a successful
	  establishment of a network connection.</para>
      </section>
      <section id="s-shrinking-online">
	<title>Shrinking on-line</title>
	<para>During shrinking it has to be ensured that the layers
	  higher than DRBD, i.e. usually the file system used by DRBD,
	  are shrunk first.<footnote>
	    <para>Whether or not the <emphasis>filesystem</emphasis>
	      can be shrunk on-line depends on the filesystem being
	      used. Most filesystems do not support on-line shrinking.
	      XFS does not support shrinking at all.</para>
	</footnote> Since DRBD cannot ask the file system how much
	  space it actually uses, you have to be careful in order not
	  to cause data loss. 
	</para>
	<para>When internal meta data are used, make sure to consider
	  the space required by the meta data. The size communicated
	  to <command>drbdadm resize</command> is the net size for the
	  file system. In the case of internal meta data, the gross
	  size required by DRBD is higher (see also <xref
	    linkend="s-meta-data-size"/>).</para>
	<para>To shrink DRBD on-line, issue the following command
	  <emphasis>after</emphasis> you have shrunk the file system
	  residing on top of it:</para>
	<programlisting>drbdadm -- --size=<replaceable>new-size</replaceable> resize <replaceable>resource</replaceable></programlisting>
	<para>You may use the usual multiplier suffixes for
	  <replaceable>new-size</replaceable> (K, M, G etc.). After
	  you have shrunk DRBD, you may also shrink the containing
	  block device (if it supports shrinking).</para>
      </section>
      <section id="s-shrinking-offline">
	<title>Shrinking off-line</title>
	<para>If you were to shrink a backing block device while DRBD
	  is inactive, DRBD would refuse to attach to this block
	  device during the next attach attempt, since it is now too
	  small (in case external meta data are used), or it would be
	  unable to find its meta data (in case internal meta data are
	  used). To work around these issues, use this procedure (if
	  you cannot use <link linkend="s-shrinking-online">on-line
	    shrinking</link>):</para>
	<warning>
	  <para>This is an advanced procedure. Use at your own
	  discretion.</para>
	</warning>
	<orderedlist>
	  <listitem>
	    <para>Shrink the file system from one node, while DRBD is
	      still configured.</para>
	  </listitem>
	  <listitem>
	    <para>Unconfigure your DRBD resource:</para>
	    <programlisting>drbdadm down <replaceable>resource</replaceable></programlisting>
	  </listitem>
	  <listitem>
	    <para>Save the meta data in a text file prior to
	      shrinking: <programlisting>drbdadm dump-md <replaceable>resource</replaceable> &gt; <filename>/tmp/metadata</filename></programlisting></para>
	    <para>You must do this on both nodes, using a separate
	      dump file for every node. <emphasis>Do not</emphasis>
	      dump the meta data on one node, and simply copy the dump
	      file to the peer.</para>
	  </listitem>
	  <listitem>
	    <para>Shrink the backing block device on both
	      nodes.</para>
	  </listitem>
	  <listitem>
	    <para>Adjust the size information
	      (<code>la-size-sect</code>) in the file
	      <filename>/tmp/metadata</filename> accordingly, on both
	      nodes. Remember that <code>la-size-sect</code> must be
	      specified in sectors.</para>
	  </listitem>
	  <listitem>
	    <para><emphasis>Only if you are using internal
		metadata</emphasis> (which at this time have probably
	      been lost due to the shrinking process), re-initialize
	      the metadata area:</para>
	    <programlisting>drbdadm create-md <replaceable>resource</replaceable></programlisting>
	  </listitem>
	  <listitem>
	    <para>Re-import the corrected meta data, on both
	      nodes:<footnote>
		<para>This example uses <code>bash</code> parameter
		  substitution. It may or may not work in other
		  shells. Check your <envar>SHELL</envar> environment
		  variable if you are unsure which shell you are
		  currently using.</para>
	    </footnote>
	    </para>
	    <literallayout><userinput>drbdmeta_cmd=$(drbdadm -d	dump-md test-disk)</userinput>
	      <userinput>${drbdmeta_cmd/dump-md/restore-md} /tmp/metadata</userinput><footnote>
		<para>This little <code>bash</code> hack will create
		  your correct <command>drbdmeta</command> command on
		  the fly. Use <command>set -x</command> prior to
		  running it if you are interested to see the command
		  being generated.</para>
	    </footnote> <computeroutput> Valid meta-data in place, overwrite? [need to type 'yes' to confirm]</computeroutput> <userinput>yes</userinput>
	      <computeroutput> Successfully restored meta data</computeroutput></literallayout>
	  </listitem>
	  <listitem>
	    <para>Re-enable your DRBD resource:</para>
	    <programlisting>drbdadm up <replaceable>resource</replaceable></programlisting>
	  </listitem>
	</orderedlist>
      </section>
    </section>
</chapter>

<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter id="ch-configure">
  <title>Configuring DRBD</title>
  <section id="s-prepare-storage">
    <title>Preparing your lower-level storage</title>
    <para>After you have installed DRBD, you must set aside a roughly
      identically sized storage area on both cluster nodes. This will
      become the <emphasis>lower-level device</emphasis> for your DRBD
      resource. You may use any type of block device found on your
      system for this purpose. Typical examples include:
	<itemizedlist>
	  <listitem>
	    <para>A hard drive partition (or a full physical hard
	      drive),</para>
	  </listitem>
	  <listitem>
	    <para>a software RAID device,</para>
	  </listitem>
	  <listitem>
	    <para>an LVM Logical Volume or any other block device
	      configured by the Linux device-mapper
	      infrastructure,</para>
	  </listitem>
	  <listitem>
	    <para>an EVMS volume,</para>
	  </listitem>
	  <listitem>
	    <para>any other block device type found on your system.
	    In DRBD version 8.3 and above, you may also use <emphasis>resource
	      stacking</emphasis>, meaning you can use one DRBD device
	    as a lower-level device for another. Some specific
	    considerations apply to stacked resources; their
	    configuration is covered in detail in <xref
	      linkend="s-three-nodes"/>.</para>
	  </listitem>
	</itemizedlist>
      </para>
      <para>
        <note>
  	  <para>While it is possible to use loop devices as lower-level
	  devices for DRBD, doing so is not recommended due to
	  deadlock issues.</para>
        </note>
      </para>
      <para>It is <emphasis>not</emphasis> necessary for this storage
      area to be empty before you create a DRBD resource from it. In
      fact it is a common use case to create a two-node cluster from a
      previously non-redundant single-server system using DRBD (some
      caveats apply &ndash; please refer to <xref
	linkend="s-metadata"/> if you are planning to do this).</para>
    <para>For the purposes of this guide, we assume a
      very simple setup:
	<itemizedlist>
	<listitem>
	  <para>Both hosts have a free (currently unused) partition
	    named <filename>/dev/sda7</filename>.</para>
	</listitem>
	<listitem>
	  <para>We are using <link
	      linkend="s-internal-meta-data">internal meta
	      data</link>.</para>
	</listitem>
	</itemizedlist>
    </para>
  </section>
  <section id="s-prepare-network">
    <title>Preparing your network configuration</title>
    <para><indexterm>
	<primary>network configuration</primary>
    </indexterm>It is recommended, though not strictly required, that
      you run your DRBD replication over a dedicated connection. At
      the time of this writing, the most reasonable choice for this is
      a direct, back-to-back, Gigabit Ethernet connection. If and when
      you run DRBD over switches, use of redundant components and the
      Linux <indexterm>
	<primary>bonding driver</primary>
      </indexterm> <code>bonding</code> driver (in
      <code>active-backup</code> mode) is recommended.</para>
    <para>It is generally not recommended to run DRBD replication
      via routers, for reasons of fairly obvious performance drawbacks
      (adversely affecting both throughput and latency).</para>
    <para><indexterm>
	<primary>firewall considerations</primary>
      </indexterm>In terms of local firewall considerations, it is
      important to understand that DRBD (by convention) uses TCP ports
      from 7788 upwards, with every TCP resource listening on a
      separate, configurable, but unchanging TCP port. DRBD uses
      <emphasis>two</emphasis> separate TCP connections (one in either
      direction) for every resource configured. For proper DRBD
      functionality, it is required that these connections are allowed
      by your firewall configuration.</para>
    <para>Security considerations other than firewalling may also
      apply if a Mandatory Access Control (MAC) scheme such as
      <indexterm>
	<primary>SELinux</primary>
      </indexterm> SELinux or AppArmor <indexterm>
	<primary>AppArmor</primary>
      </indexterm> is enabled. You may have to adjust your local
      security policy so it does not keep DRBD from functioning
      properly.</para>
    <para>You must, of course, also ensure that the TCP ports you
      will be using for DRBD are not already being used by another
      application.
      <note>
	<para>It is not possible to configure a DRBD resource to
	  support more than one TCP connection. If you want to provide
	  for DRBD connection load-balancing or redundancy, you can
	  easily do so at the Ethernet level (again, using the
	  <code>bonding</code> driver).</para>
      </note>
    </para>
    <para>For the purposes of this guide, we assume a
      very simple setup:
      <itemizedlist>
	<listitem>
	  <para>Our two DRBD hosts each have a currently unused
	    network interface, <code>eth1</code>, with IP addresses
	    <code>10.1.1.31</code> and <code>10.1.1.32</code>
	    assigned to it, respectively.</para>
	</listitem>
	<listitem>
	  <para>No other services are using TCP ports 7788 through
	    7799 on either host.</para>
	</listitem>
	<listitem>
	  <para>The local firewall configuration allows both inbound
	    and outbound TCP connections between the hosts over these
	    ports.</para>
	</listitem>
      </itemizedlist>
    </para>
  </section>
  <section id="s-configure-resource">
    <title>Configuring your resource</title>
    <para><indexterm>
      <primary>drbd.conf</primary> </indexterm>All aspects of DRBD are
      controlled in its configuration file,
      <filename>/etc/drbd.conf</filename>. Normally, this
      configuration file is just a skeleton with the following
      contents:</para>
      <programlisting>include "/etc/drbd.d/global_common.conf";
include "/etc/drbd.d/*.res";</programlisting>
      <para>By convention,
      <filename>/etc/drbd.d/global_common.conf</filename> contains the 
      <link linkend="s-drbdconf-global"><code>global</code></link> and
      <link linkend="s-drbdconf-common"><code>common</code></link>
      sections of the DRBD configuration, whereas the
      <filename>.res</filename> files contain one <link
      linkend="s-drbdconf-resource"><code>resource</code></link>
      section each.</para>
      <para>It is also possible to use <filename>drbd.conf</filename>
      as a flat configuration file without any <code>include</code>
      statements at all. Such a configuration, however, quickly
      becomes cluttered and hard to manage, which is why the
      multiple-file approach is the preferred one.</para>
      <para>Regardless of which approach you employ, you should always
      make sure that <filename>drbd.conf</filename>, and any other
      files it includes, are <emphasis>exactly identical</emphasis> on
      all participating cluster nodes.</para>
    <para>The DRBD source tarball contains an example configuration
      file in the <filename>scripts</filename>
      subdirectory. Binary installation packages will either install
      this example configuration directly in
      <filename>/etc</filename>, or in a package-specific
      documentation directory such as
      <filename>/usr/share/doc/packages/drbd</filename>.
    </para>
    <note>
      <para>This section describes only those few aspects of the
	configuration file which are absolutely necessary to
	understand in order to get DRBD up and running. The
	configuration file's syntax and contents are documented in
	great detail in <xref
	  linkend="re-drbdconf"/>.</para>
    </note>
    <section id="s-drbdconf-example">
      <title>Example configuration</title>
      <para>For the purposes of this guide, we assume a
	minimal setup in line with the examples given in the
	previous sections:</para>
      <programlisting>global {
  usage-count yes;
}
common {
  protocol C;
}
resource r0 {
  on alice {
    device    /dev/drbd1;
    disk      /dev/sda7;
    address   10.1.1.31:7789;
    meta-disk internal;
  }
  on bob {
    device    /dev/drbd1;
    disk      /dev/sda7;
    address   10.1.1.32:7789;
    meta-disk internal;
  }
}
</programlisting>
      <para>This example configures DRBD in the following fashion:
	<itemizedlist>
	  <listitem>
	    <para>You "opt in" to be included in DRBD's usage
	      statistics (see <link
		linkend="fp-usage-count">below</link>).</para>
	  </listitem>
	  <listitem>
	    <para>Resources are configured to use fully synchronous
	      replication (<link
		linkend="s-replication-protocols">Protocol C</link>)
	      unless explicitly specified otherwise.</para>
	  </listitem>
	  <listitem>
	    <para>Our cluster consists of two nodes,
	      <code>alice</code> and <code>bob</code>.</para>
	  </listitem>
	  <listitem>
	    <para>We have a resource arbitrarily named <code>r0</code>
	      which uses <filename>/dev/sda7</filename> as the
	      lower-level device, and is configured with <link
		linkend="s-internal-meta-data">internal meta
		data</link>.</para>
	  </listitem>
	  <listitem>
	    <para>The resource uses TCP port 7789 for its network
	    connections, and binds to the IP addresses 10.1.1.31 and
	    10.1.1.32, respectively.</para>
	  </listitem>
	</itemizedlist>
      </para>
    </section>
    <section id="s-drbdconf-global">
      <title>The <code>global</code> section</title>
      <para><indexterm>
	  <primary>drbd.conf</primary>
	  <secondary>global</secondary> </indexterm>This section is
	  allowed only once in the configuration. It is normally in
	  the <filename>/etc/drbd.d/global_common.conf</filename>
	  file. In a single-file configuration, it should go to the
	  very top of the configuration file. Of the few options
	  available in this section, only one is of relevance to most
	  users:</para>
      <formalpara id="fp-usage-count">
	<title><option>usage-count</option></title>
	<para>The DRBD project keeps statistics about the usage of
	  various DRBD versions. This is done by contacting an HTTP server
	  every time a new DRBD version is installed on a system. This
	  can be disabled by setting <option>usage-count no;</option>.
	  The default is <option>usage-count ask;</option> which will
	  prompt you every time you upgrade DRBD.
	  <note>
	    <para>DRBD's usage statistics are, of course, publicly
	      available: see <ulink
		url="http://usage.drbd.org"/>.</para>
	    </note>
	</para>
      </formalpara>
    </section>
    <section id="s-drbdconf-common">
      <title>The <code>common</code> section</title>
      <para><indexterm>
	  <primary>drbd.conf</primary>
	  <secondary>common</secondary>
      </indexterm>This section provides a shorthand method to define
	configuration settings inherited by every resource. It is
	normally found in
	<filename>/etc/drbd.d/global_common.conf</filename>. You may
	define any option you can also define on a per-resource
	basis.</para>
      <para>Including a <code>common</code> section is not strictly
	required, but strongly recommended if you are using more
	than one resource. Otherwise, the configuration quickly
	becomes convoluted by repeatedly-used options.</para>
      <para>In the example above, we included
	<code>protocol C;</code> in the <code>common</code>
	section, so every resource configured (including
	<code>r0</code>) inherits this option unless it has another
	<code>protocol</code> option configured explicitly. For
	other synchronization protocols available, see <xref
	  linkend="s-replication-protocols"/>.</para>
    </section>
    <section id="s-drbdconf-resource">
      <title>The <code>resource</code> sections</title>
      <para><indexterm>
	  <primary>drbd.conf</primary>
	  <secondary>resource</secondary>
      </indexterm>A per-resource configuration file is usually named
      <filename>/etc/drbd.d/<replaceable>resource</replaceable>.res</filename>.
      Any DRBD resource you define must be named by
	specifying <option>resource
	  <replaceable>name</replaceable></option> in the
	configuration. You may use any arbitrary identifier,
	however the name must not contain characters other than those
	found in the US-ASCII character set, and must also not include
	whitespace.</para>
      <para>Every resource configuration must also have two
	<option>on <replaceable>host</replaceable></option>
	sub-sections (one for every cluster node). </para>
      <para>All other configuration settings are either inherited
	from the <code>common</code> section (if it exists), or
	derived from DRBD's default settings.</para>
      <para>In fact, you can use a shorthand notation for the
	<option>on <replaceable>host</replaceable></option>
	sub-sections, too: every option whose values are equal on
	both hosts may be specified directly in the
	<option>resource</option> section. Thus, we can further
	condense this section, in comparison with the example
	cited above:</para>
      <programlisting>resource r0 {
  device    /dev/drbd1;
  disk      /dev/sda7;
  meta-disk internal;
  on alice {
    address   10.1.1.31:7789;
  }
  on bob {
    address   10.1.1.32:7789;
  }
}
      </programlisting>
      <para>This notation is available in DRBD versions 8.2.1 and above.</para>
    </section>
  </section>
  <section id="s-first-time-up">
    <title>Enabling your resource for the first time</title>
    <para>After you have completed initial resource configuration as
      outlined in the previous sections, you can bring up your
      resource.</para>
    <note>
      <para>Each of the following steps must be completed on both nodes.</para>
    </note>
    <orderedlist>
      <listitem>
	<formalpara>
	  <title>Create device metadata</title>
	  <indexterm>
	    <primary>drbdadm</primary>
	    <secondary>create-md</secondary>
	  </indexterm>
	  <para>This step must be completed only on initial device
	    creation. It initializes DRBD's metadata:
	    <screen><userinput>drbdadm create-md <replaceable>resource</replaceable></userinput>
<computeroutput>v08 Magic number not found
Writing meta data...
initialising activity log
NOT initialized bitmap
New drbd meta data block sucessfully created.
success</computeroutput>
	    </screen>
	  </para>
	</formalpara>
      </listitem>
      <listitem>
	  <formalpara>
	  <title>Attach to backing device</title>
	  <indexterm>
	    <primary>drbdadm</primary>
	    <secondary>attach</secondary>
	  </indexterm>
	  <para>This step associates the DRBD resource with its
	    backing device:
	    <screen><userinput>drbdadm attach <replaceable>resource</replaceable></userinput></screen>
	  </para>
	</formalpara>
      </listitem>
      <listitem>
	<formalpara>
	  <title>Set synchronization parameters</title>
	  <indexterm>
	    <primary>drbdadm</primary>
	    <secondary>syncer</secondary>
	  </indexterm>
	  <para>This step sets synchronization parameters for the DRBD
	  resource:
	    <screen><userinput>drbdadm syncer <replaceable>resource</replaceable></userinput></screen>
	  </para>
	</formalpara>
      </listitem>
      <listitem>
	<formalpara>
	  <title>Connect to peer</title>
	  <indexterm>
	    <primary>drbdadm</primary>
	    <secondary>connect</secondary>
	  </indexterm>
	  <para>This step connects the DRBD resource with its
	    counterpart on the peer node:
	    <screen><userinput>drbdadm connect <replaceable>resource</replaceable></userinput></screen>
	  </para>
	</formalpara>
	<tip>
	  <indexterm>
	    <primary>drbdadm</primary>
	    <secondary>up</secondary>
	  </indexterm>
	  <para>You may collapse the steps <command>drbdadm
	      attach</command>, <command>drbdadm syncer</command>, and
	    <command>drbdadm connect</command> into one, by using the
	    shorthand command <command>drbdadm up</command>.</para>
	</tip>
      </listitem>
      <listitem>
	<formalpara>
	  <title>Observe <filename>/proc/drbd</filename></title>
	  <para>DRBD's virtual status file in the
	    <filename>/proc</filename> filesystem,
	    <filename>/proc/drbd</filename>, should now contain
	    information similar to the following:</para>
	</formalpara>
	<screen><userinput>cat /proc/drbd</userinput>
<computeroutput>version: 8.3.0 (api:88/proto:86-89)
GIT-hash: 9ba8b93e24d842f0dd3fb1f9b90e8348ddb95829 build by buildsystem@linbit, 2008-12-18 16:02:26
 1: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r---
    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:200768
</computeroutput></screen>
	<para>The
	  <computeroutput>Inconsistent/Inconsistent</computeroutput>
	  disk state is expected at this point.</para>
      </listitem>
    </orderedlist>
    <para>By now, DRBD has successfully allocated both disk and
      network resources and is ready for operation. What it does not
      know yet is which of your nodes should be used as the source of
      the initial device synchronization. </para>
  </section>
  <section id="s-initial-full-sync">
    <title>The initial device synchronization</title>
    <para>There are two more steps required for DRBD to become fully
      operational:</para>
    <orderedlist>
      <listitem>
	<formalpara>
	  <title>Select an initial sync source</title>
	  <para>If you are dealing with newly-initialized, empty disk,
	    this choice is entirely arbitrary. If one of your nodes
	    already has valuable data that you need to preserve,
	    however, <emphasis>it is of crucial importance</emphasis>
	    that you select that node as your synchronization source.
	    If you do initial device synchronization in the wrong
	    direction, you will lose that data. Exercise
	    caution.</para>
	</formalpara>
      </listitem>
      <listitem>
	<formalpara>
	  <title>Start the initial full synchronization</title>
	  <indexterm>
	    <primary>drbdadm</primary>
	    <secondary>primary</secondary>
	  </indexterm>
	  <para>This step must be performed on only one node, only on
	    initial resource configuration, and only on the node you
	    selected as the synchronization source. To perform this
	    step, issue this command:
	    <screen><userinput>drbdadm -- --overwrite-data-of-peer primary <replaceable>resource</replaceable></userinput></screen>
	  </para>
	</formalpara>
	<para>After issuing this command, the initial full
	  synchronization will commence. You will be able to monitor
	  its progress via <filename>/proc/drbd</filename>. It may
	  take some time depending on the size of the device.
	</para>
      </listitem>
    </orderedlist>
    <para>By now, your DRBD device is fully operational, even before
      the initial synchronization has completed (albeit with slightly
      reduced performance). You may now create a filesystem on the
      device, use it as a raw block device, mount it, and perform any
      other operation you would with an accessible block
      device.</para>
    <para>You will now probably want to continue with <xref
	linkend="ch-admin"/>, which describes common administrative
      tasks to perform on your resource.</para>
  </section>
  <section id="s-using-truck-based-replication">
    <title>Using truck based replication</title>
    <para>In order to preseed a remote node with data which is then to
    be kept synchronized, and to skip the initial device
    synchronization, follow these steps.</para>
    <note>
      <para>This assumes that your local node has a configured, but
	disconnected DRBD resource in the Primary role.</para>
      <para>That is to say, device configuration is completed,
	identical <filename>drbd.conf</filename> copies exist on both
	nodes, and you have issued the commands for <link
	  linkend="s-initial-full-sync">initial resource
	  promotion</link> on your local node &mdash; but the remote
	node is not connected yet.</para>
    </note>
    <orderedlist>
      <listitem>
	<para>On the local node, issue the following command:
	  <screen><userinput>drbdadm -- --clear-bitmap new-current-uuid <replaceable>resource</replaceable></userinput></screen></para>
      </listitem>
      <listitem>
	<para>Create a consistent, verbatim copy of the resource's
	  data <emphasis>and its metadata</emphasis>. You may do so,
	  for example, by removing a hot-swappable drive from a RAID-1
	  mirror.  You would, of course, replace it with a fresh
	  drive, and rebuild the RAID set, to ensure continued
	  redundancy. But the removed drive is a verbatim copy that
	  can now be shipped off site.</para>
	<para>If your local block device supports snapshot copies
	  (such as when using DRBD on top of LVM), you may also create
	  a bitwise copy of that snapshot using <code>dd</code>.
	</para>
      </listitem>
      <listitem>
	<para>On the local node, issue:
	  <screen><userinput>drbdadm new-current-uuid <replaceable>resource</replaceable></userinput></screen></para>
	<para>Note the absence of the <option>--clear-bitmap</option>
	  option in this second invocation.</para>
      </listitem>
      <listitem>
	<para>Physically transport the copies to the remote peer
	location.</para>
      </listitem>
      <listitem>
	<para>Add the copies to the remote node. This may again be a
	  matter of plugging a physical disk, or grafting a bitwise
	  copy of your shipped data onto existing storage on the
	  remote node.</para>
	<para>Be sure to restore or copy not only your replicated
	  data, but also the associated DRBD metadata. If you fail to
	  do so, the disk shipping process is moot.</para>
      </listitem>
      <listitem>
	<para>Bring up the resource on the remote node:
	  <screen><userinput>drbdadm up <replaceable>resource</replaceable></userinput></screen></para>
      </listitem>
    </orderedlist>
    <para>After the two peers connect, they will not initiate a full
      device synchronization. Instead, the automatic synchronization
      that now commences only covers those blocks that changed since
      the invocation of
      <code>drbdadm&nbsp;--&nbsp;--clear-bitmap&nbsp;new-current-uuid</code>.</para>
    <para>Even if there were <emphasis>no</emphasis> changes
      whatsoever since then, there may still be a brief
      synchronization period due to areas covered by the <link
	linkend="s-activity-log">Activity Log</link> being rolled back
      on the new Secondary. This may be mitigated by the use of <link
	linkend="p-checksum-sync">checksum-based
	synchronization</link>.</para>
    <tip>
      <para>You may use this same procedure regardless of whether the
      resource is a regular DRBD resource, or a stacked resource. For
	stacked resources, simply add the <option>-S</option> or
	<option>--stacked</option> option to <code>drbdadm</code>.</para>
    </tip>
  </section>
</chapter>
